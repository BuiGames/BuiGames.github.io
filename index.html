<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bui Project - The Adventure</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            flex-direction: column;
        }

        .game-container {
            border: 8px solid #444;
            border-radius: 15px;
            background-color: #000;
            padding: 20px;
            box-shadow: 0 0 25px #ff00ff, 0 0 15px #00ffff inset;
            position: relative;
        }

        canvas {
            background-color: #0d0d0d;
            display: block;
            border-radius: 5px;
            border: 2px solid #333;
            cursor: pointer;
        }

        .message-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .final-message {
            font-size: 2rem;
            color: #00ff00;
            line-height: 1.6;
            text-shadow: 2px 2px 0px #1a1a1a;
            max-width: 90%;
        }

        .cta-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .cta-button {
            display: inline-block;
            background-color: #ffff00;
            color: #1a1a1a;
            padding: 15px 30px;
            margin: 15px;
            border-radius: 5px;
            text-decoration: none;
            font-size: 1.2rem;
            text-shadow: none;
            border: 3px solid #1a1a1a;
            box-shadow: 5px 5px 0px #ff00ff;
            transition: all 0.1s linear;
        }

        .cta-button:hover {
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0px #ff00ff;
        }
        .cta-button:active {
            transform: translate(5px, 5px);
            box-shadow: 0 0 0 #ff00ff;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

    <div class="game-container">
        <canvas id="gameCanvas" width="1200" height="800"></canvas>
        <div id="messageOverlay" class="message-overlay">
            <div id="messageText" class="final-message"></div>
        </div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const messageOverlay = document.getElementById('messageOverlay');
    const messageText = document.getElementById('messageText');

    // --- Game States & Data ---
    const GAME_STATES = {
        CHOOSE_PRODUCT: 'CHOOSE_PRODUCT',
        CREATE_TECH_PACK: 'CREATE_TECH_PACK',
        CHOOSE_FABRIC: 'CHOOSE_FABRIC',
        CHOOSE_MANUFACTURER: 'CHOOSE_MANUFACTURER',
        SAMPLING_LOOP: 'SAMPLING_LOOP',
        SHOW_EMAIL_TEXT: 'SHOW_EMAIL_TEXT',
        REVEAL_PERFECT: 'REVEAL_PERFECT'
    };
    let gameState = GAME_STATES.CHOOSE_PRODUCT;
    let userChoices = {};
    let hoverTarget = null;
    let animationState = {};
    let rainbowHue = 0;
    let clickRegions = {};
    let emailTextLines = [];
    
    const emailText = `Hey Leon,

Mein Kollege Leo hat dich bereits kontaktiert bezüglich potenzieller Diversifikation eurer Produktionsstätten. Habt ihr schon über die Produktion in Vietnam nachgedacht? Ich gehe davon aus, ihr produziert primär in China und habt keinen internen Kontakt in China?

Ich als Designer habe einen Sample Room in Saigon City und zusätzlich unterstützen wir Brands, die in Vietnam produzieren wollen. Heißt, wir übernehmen die Kommunikation mit Produktionsstätten, handhaben Sampling bis zur fertigen Produktion und den Transport zu euch.

Vorteil ist transparente Kommunikation von Produktionsabläufen, Verständnis von komplizierten Designs, frühe Erkennung von Produktionsfehlern und eine smoothere Samplingphase, da wir vor Ort direkt mit großen und kleinen Manufakturen arbeiten.

Da wir agil arbeiten und ein riesiges Netzwerk in Vietnam haben, können wir bereits sehr kleine Mengen sowie Einzelstücke in vergleichbar kurzer Zeit und zu lokalen Preisen anfertigen lassen. Natürlich kommt es auf das spezifische Produkt an.

Falls das interessant für euch ist, können wir uns gerne über Produktion austauschen.`;


    function setRegions(regions) {
        clickRegions[gameState] = regions;
    }

    function initializeGame() {
        userChoices = {
            product: null,
            techPack: { measurements: false, fabric: false, colors: false, stitching: false },
            fabricChoice: null,
            manufacturer: null,
            sampling: { count: 1, cost: 200, time: 4, flaw: null },
            factoryMismatch: false,
            missedStitching: false,
            choseBudgetFabric: false,
        };
        animationState = { frame: 0, x: -200, alpha: 0, subState: 0, subFrame: 0, textScrollY: 0, maxScrollY: 0 };
        gameState = GAME_STATES.CHOOSE_PRODUCT;
    }

    // --- Drawing Assets ---
    function drawIdealHat(x, y, scale = 1) {
        ctx.save();
        ctx.translate(x, y);
        ctx.scale(scale, scale);
        ctx.fillStyle = '#ff1493'; // Deep Pink
        ctx.beginPath();
        ctx.ellipse(100, 100, 100, 25, 0, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#ff69b4'; // Hot Pink
        ctx.beginPath();
        ctx.ellipse(100, 70, 60, 40, 0, 0, Math.PI * 2);
        ctx.fill();

        // Glisten animation
        const glintPosition = (animationState.frame % 200) - 50; // A value from -50 to 150
        if (glintPosition > 0 && glintPosition < 120) {
             ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
             ctx.save();
             ctx.rotate(-0.2);
             ctx.fillRect(glintPosition, 40, 20, 50);
             ctx.restore();
        }

        ctx.restore();
    }

    function drawIdealPants(x, y, scale = 1) {
        ctx.save();
        ctx.translate(x, y);
        ctx.scale(scale, scale);
        ctx.fillStyle = '#1e90ff'; // Dodger Blue
        
        // Left leg
        ctx.beginPath();
        ctx.moveTo(50, 0);
        ctx.lineTo(100, 0);
        ctx.lineTo(80, 150);
        ctx.lineTo(30, 150);
        ctx.closePath();
        ctx.fill();

        // Right leg
        ctx.beginPath();
        ctx.moveTo(110, 0);
        ctx.lineTo(160, 0);
        ctx.lineTo(180, 150);
        ctx.lineTo(130, 150);
        ctx.closePath();
        ctx.fill();

        // Waistband
        ctx.fillRect(50, -10, 110, 20);
        ctx.restore();
    }

    function drawIdealTop(x, y, scale = 1) {
        ctx.save();
        ctx.translate(x, y);
        ctx.scale(scale, scale);

        // Animated shiny gradient
        const gradient = ctx.createLinearGradient(50, 0, 150, 150);
        const colorStop1 = (Math.sin(animationState.frame * 0.05) + 1) / 2; // oscillates between 0 and 1
        gradient.addColorStop(0, '#32cd32');
        gradient.addColorStop(colorStop1, '#adff2f');
        gradient.addColorStop(1, '#32cd32');

        ctx.fillStyle = gradient; 
        ctx.beginPath();
        ctx.moveTo(50, 0);
        ctx.lineTo(150, 0);
        ctx.lineTo(120, 150);
        ctx.lineTo(80, 150);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }
    
    const idealProducts = {
        hat: { draw: drawIdealHat, name: "A Fabulous Hat" },
        pants: { draw: drawIdealPants, name: "Trendy Pants" },
        top: { draw: drawIdealTop, name: "A Cute Top" },
    };

    function drawWireframe(product, x, y, scale = 1) {
        ctx.save();
        ctx.translate(x, y);
        ctx.scale(scale, scale);
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.beginPath();
        if (product === 'hat') {
            ctx.ellipse(100, 100, 100, 25, 0, 0, Math.PI * 2);
            ctx.ellipse(100, 70, 60, 40, 0, 0, Math.PI * 2);
        } else if (product === 'pants') {
            ctx.rect(50, -10 , 110, 20);
            ctx.moveTo(50, 0); ctx.lineTo(30, 150); ctx.lineTo(80, 150); ctx.lineTo(100, 0);
            ctx.moveTo(110, 0); ctx.lineTo(130, 150); ctx.lineTo(180, 150); ctx.lineTo(160, 0);
        } else { // top
            ctx.moveTo(50, 0); ctx.lineTo(150, 0); ctx.lineTo(120, 150); ctx.lineTo(80, 150); ctx.closePath();
        }
        ctx.stroke();
        ctx.restore();
    }
    
    // Icons
    function drawIcons(type, x, y) {
        ctx.save();
        ctx.strokeStyle = '#fff';
        ctx.fillStyle = '#fff';
        ctx.lineWidth = 2;
        if(type === 't-shirt'){
            ctx.beginPath();
            ctx.moveTo(x,y); ctx.lineTo(x+30,y); ctx.lineTo(x+25,y+25); ctx.lineTo(x+5,y+25); ctx.closePath();
            ctx.stroke();
        } else if(type === 'sweater'){
            ctx.strokeRect(x,y,30,25); ctx.strokeRect(x+5,y-5,20,5);
        } else if(type === 'jacket'){
            ctx.strokeRect(x,y,30,25); ctx.beginPath(); ctx.moveTo(x+15,y); ctx.lineTo(x+15,y-5); ctx.stroke();
        } else if(type === 'moq-low'){
            ctx.strokeRect(x,y,20,10);
        } else if(type === 'moq-medium'){
            ctx.strokeRect(x,y,20,10); ctx.strokeRect(x,y+12,20,10);
        } else if(type === 'moq-high'){
            ctx.strokeRect(x,y,20,10); ctx.strokeRect(x,y+12,20,10); ctx.strokeRect(x,y+24,20,10);
        }
        ctx.restore();
    }
    
    // Flaw renderers
    function drawBadStitching(item, x, y) {
        drawWireframe(item, x, y);
        ctx.save();
        
        const needleX = x + (animationState.frame % 150);
        const needleY = y + 50;
        
        ctx.strokeStyle = '#c0c0c0'; // Silver
        ctx.lineWidth = 4;

        if (needleX > x + 100) { // Break point
            // Broken needle
            ctx.beginPath();
            ctx.moveTo(x + 100, needleY - 10);
            ctx.lineTo(x + 95, needleY + 5);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x + 105, needleY - 5);
            ctx.lineTo(x + 100, needleY + 10);
            ctx.stroke();
        } else {
            // Intact needle
            ctx.beginPath();
            ctx.moveTo(needleX, needleY - 10);
            ctx.lineTo(needleX - 5, needleY + 10);
            ctx.stroke();
        }

        ctx.restore();
        drawText("Bad Stitching!", x + 100, y + 200, 16, '#ff4d4d');
    }

    function drawWrongColor(item, x, y) {
        ctx.save();
        ctx.fillStyle = '#8B4513'; // SaddleBrown
        ctx.globalAlpha = 0.8;
        if (item === 'hat') { ctx.beginPath(); ctx.ellipse(x+100, y+100, 100, 25, 0, 0, Math.PI*2); ctx.ellipse(x+100, y+70, 60, 40, 0, 0, Math.PI*2); ctx.fill(); }
        else if (item === 'pants') {
             ctx.beginPath();
            ctx.moveTo(x+50, y+0); ctx.lineTo(x+100, y+0); ctx.lineTo(x+80, y+150); ctx.lineTo(x+30, y+150); ctx.closePath(); ctx.fill();
            ctx.beginPath();
            ctx.moveTo(x+110, y+0); ctx.lineTo(x+160, y+0); ctx.lineTo(x+180, y+150); ctx.lineTo(x+130, y+150); ctx.closePath(); ctx.fill();
        } else {
            ctx.beginPath(); ctx.moveTo(x+50, y+0); ctx.lineTo(x+150, y+0); ctx.lineTo(x+120, y+150); ctx.lineTo(x+80, y+150); ctx.closePath(); ctx.fill();
        }
        ctx.restore();
        drawWireframe(item, x, y);
        drawText("Wrong Color!", x+100, y + 200, 16, '#ff4d4d');
    }

    function drawWrongSize(item, x, y) {
        drawWireframe(item, x + 50, y + 50, 0.5); // Draw at half size
        drawText("Wrong Size!", x + 100, y + 200, 16, '#ff4d4d');
    }

    function drawChemicalSmell(item, x, y) {
        drawWireframe(item, x, y);
        ctx.save();
        ctx.fillStyle = 'rgba(152, 251, 152, 0.6)'; // PaleGreen
        for (let i = 0; i < 5; i++) {
            const sx = x + 50 + (i * 20);
            const sy = y + 80 - (animationState.frame % 100);
            const wave = Math.sin((animationState.frame + i*20) * 0.1) * 10;
            ctx.beginPath();
            ctx.arc(sx + wave, sy, 5, 0, Math.PI * 2);
            ctx.fill();
        }
        ctx.restore();
        drawText("Chemical Smell!", x+100, y + 200, 16, '#ff4d4d');
    }

    function drawFuzzies(item, x, y) {
        drawWireframe(item, x, y);
        ctx.save();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        for (let i=0; i < 40; i++) {
             ctx.beginPath();
             ctx.arc(x + Math.random() * 200, y + Math.random() * 150, 2, 0, Math.PI * 2);
             ctx.fill();
        }
        ctx.restore();
        drawText("Fuzzies All Over!", x+100, y + 200, 16, '#ff4d4d');
    }


    // --- State Drawing Functions ---
    function drawChooseProductScreen() {
        drawText("First, choose your creation:", canvas.width / 2, 100);
        
        const regions = [
            { id: 'hat', x: 150, y: 300, w: 200, h: 200 },
            { id: 'pants', x: 500, y: 300, w: 200, h: 200 },
            { id: 'top', x: 850, y: 300, w: 200, h: 200 },
        ];

        regions.forEach(region => {
            ctx.strokeStyle = (hoverTarget === region.id) ? '#ffff00' : '#555';
            ctx.lineWidth = 4;
            ctx.strokeRect(region.x - 20, region.y - 20, region.w + 40, region.h + 40);
            idealProducts[region.id].draw(region.x, region.y);
            drawText(idealProducts[region.id].name, region.x + region.w / 2, region.y + 250, 16);
        });
        setRegions(regions);
    }
    function drawCreateTechPackScreen() {
        drawText("A detailed Tech Pack prevents errors.", canvas.width/2, 100);
        drawText("Finalize yours.", canvas.width/2, 150, 24, (animationState.frame % 60 < 30) ? '#ffff00' : '#fff');
        
        drawWireframe(userChoices.product, canvas.width/2 - 100, 250);

        const buttons = [
            { id: 'measurements', text: 'Measurements', x: 150, y: 600, w: 250, h: 60 },
            { id: 'fabric', text: 'Fabric Specs', x: 475, y: 600, w: 250, h: 60 },
            { id: 'colors', text: 'Color Codes', x: 800, y: 600, w: 250, h: 60 },
            { id: 'stitching', text: 'Stitching Details', x: 1000, y: 200, w: 180, h: 50 },
        ];
        
        buttons.forEach(b => {
            const isDone = userChoices.techPack[b.id];
            drawButton(b.text + (isDone ? ' ✓' : ''), b.x, b.y, b.w, b.h, hoverTarget === b.id, isDone, b.id);
        });

        if (userChoices.techPack.measurements && userChoices.techPack.fabric && userChoices.techPack.colors) {
            const sendBtn = { id: 'send', text: 'Send to Factory', x: canvas.width/2 - 200, y: 700, w: 400, h: 70 };
            drawButton(sendBtn.text, sendBtn.x, sendBtn.y, sendBtn.w, sendBtn.h, hoverTarget === sendBtn.id, false, sendBtn.id);
            setRegions([...buttons, sendBtn]);
        } else {
            setRegions(buttons);
        }
    }
    function drawChooseFabricScreen() {
        drawText("Choose your fabric:", canvas.width/2, 150);
        const options = [
            {id: 'budget', x: 200, y: 300, w: 350, h: 300, title: 'Budget Polyester', price: '$', attr: 'High risk of color bleeding'},
            {id: 'premium', x: 650, y: 300, w: 350, h: 300, title: 'Premium Supima Cotton', price: '$$$', attr: 'Excellent color retention'}
        ];
        options.forEach(o => {
            ctx.strokeStyle = (hoverTarget === o.id) ? '#ffff00' : '#555';
            ctx.lineWidth = 4;
            ctx.strokeRect(o.x, o.y, o.w, o.h);
            drawText(o.title, o.x + o.w/2, o.y + 70, 16);
            drawText(o.price, o.x + o.w/2, o.y + 150, 40, '#00ff00');
            drawText(o.attr, o.x + o.w/2, o.y + 230, 12, '#aaa');
        });
        setRegions(options);
    }
    function drawManufacturer(x, y, m) {
        // Flag
        ctx.save();
        if (m.id === 'china') {
            ctx.fillStyle = '#de2910';
            ctx.fillRect(x - 40, y - 90, 80, 50);
            ctx.fillStyle = '#ffde00';
            ctx.beginPath();
            ctx.arc(x - 25, y - 75, 5, 0, Math.PI * 2);
            ctx.fill();
        } else if (m.id === 'portugal') {
            ctx.fillStyle = '#006600';
            ctx.fillRect(x - 40, y - 90, 32, 50);
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(x - 8, y - 90, 48, 50);
        } else if (m.id === 'germany') {
            ctx.fillStyle = '#000';
            ctx.fillRect(x - 40, y - 90, 80, 17);
            ctx.fillStyle = '#dd0000';
            ctx.fillRect(x - 40, y - 73, 80, 17);
            ctx.fillStyle = '#ffce00';
            ctx.fillRect(x - 40, y - 56, 80, 17);
        }
        ctx.restore();


        // Head
        ctx.fillStyle = '#F5DEB3'; // Wheat
        ctx.beginPath();
        ctx.arc(x, y, 50, 0, Math.PI * 2);
        ctx.fill();

        // Eyes
        ctx.fillStyle = '#000';
        ctx.beginPath();
        ctx.arc(x - 20, y - 10, 5, 0, Math.PI * 2);
        ctx.arc(x + 20, y - 10, 5, 0, Math.PI * 2);
        ctx.fill();

        // Smile
        ctx.beginPath();
        ctx.arc(x, y + 10, 25, 0.2 * Math.PI, 0.8 * Math.PI);
        ctx.stroke();

        ctx.font = '16px "Press Start 2P"';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#fff';
        ctx.fillText(m.name, x, y + 80);
    }

    function drawManufacturerScreen() {
        drawText("Select a factory partner:", canvas.width/2, 100);
        const manufacturers = [
            { id: 'china', x: 250, y: 400, name: 'China', cost: '$', spec: 'All-Rounder', specIcon: 't-shirt', moq: 'High', moqIcon: 'moq-high' },
            { id: 'portugal', x: 600, y: 400, name: 'Portugal', cost: '$$', spec: 'Knitwear & Jersey', specIcon: 'sweater', moq: 'Medium', moqIcon: 'moq-medium' },
            { id: 'germany', x: 950, y: 400, name: 'Germany', cost: '$$$', spec: 'Technical Apparel', specIcon: 'jacket', moq: 'Low', moqIcon: 'moq-low' }
        ];

        manufacturers.forEach(m => {
            drawManufacturer(m.x, m.y, m);
            if (hoverTarget === m.id) {
                drawText(`Cost: ${m.cost}`, m.x, m.y + 130, 16, '#00ff00');
                drawText(m.spec, m.x, m.y + 160, 12);
                drawIcons(m.specIcon, m.x - 15, m.y + 170);
                drawText(`MOQ: ${m.moq}`, m.x, m.y + 220, 12);
                drawIcons(m.moqIcon, m.x - 10, m.y + 230);
            }
        });
        setRegions(manufacturers.map(m => ({id: m.id, x: m.x-50, y: m.y-50, w: 100, h:100})));
    }
    
    function drawShippingScreen() {
        if (userChoices.manufacturer === 'germany') { // Truck
            ctx.fillStyle = '#ffff00';
            ctx.fillRect(animationState.x, canvas.height/2, 100, 50); // Body
            ctx.fillRect(animationState.x + 100, canvas.height/2 + 20, 40, 30); // Cab
            ctx.fillStyle = '#555';
            ctx.beginPath();
            ctx.arc(animationState.x + 20, canvas.height/2 + 50, 15, 0, Math.PI * 2);
            ctx.arc(animationState.x + 90, canvas.height/2 + 50, 15, 0, Math.PI * 2);
            ctx.fill();
        } else if (userChoices.manufacturer === 'portugal') { // Plane
            ctx.fillStyle = '#c0c0c0'; // Silver
            ctx.beginPath();
            ctx.moveTo(animationState.x, canvas.height / 2 + 10);
            ctx.lineTo(animationState.x + 150, canvas.height / 2 + 10);
            ctx.lineTo(animationState.x + 180, canvas.height / 2);
            ctx.lineTo(animationState.x, canvas.height / 2);
            ctx.closePath();
            ctx.fill();
            // Wings
            ctx.fillRect(animationState.x + 50, canvas.height / 2 - 20, 20, 50);
        } else { // Boat
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.moveTo(animationState.x, canvas.height/2);
            ctx.lineTo(animationState.x + 200, canvas.height/2);
            ctx.lineTo(animationState.x + 170, canvas.height/2 + 50);
            ctx.lineTo(animationState.x + 30, canvas.height/2 + 50);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.fillRect(animationState.x + 40, canvas.height/2 - 30, 120, 30);
        }
    }

    function drawSamplingLoopScreen() {
        // Sub-states: 0=shipping, 1=revealing
        if (animationState.subState === 0) { // Shipping
            drawText("Shipping your sample...", canvas.width/2, 100);
            drawShippingScreen();
            animationState.x += 5;
            if (animationState.x > canvas.width) {
                 animationState.subState = 1; // Move to reveal
                 animationState.x = -200;
            }
        } else { // Revealing
            const { count, cost, time, flaw } = userChoices.sampling;
            drawText(`Sample: #${count} | Cost: $${cost} | Time: ${time} Weeks`, canvas.width/2, 80);
            drawText("It's wrong! What will you do?", canvas.width/2, 150, 24, '#ff4d4d');

            const itemX = canvas.width/2 - 100;
            const itemY = 250;
            if (flaw === 'stitching') drawBadStitching(userChoices.product, itemX, itemY);
            else if (flaw === 'color') drawWrongColor(userChoices.product, itemX, itemY);
            else if (flaw === 'size') drawWrongSize(userChoices.product, itemX, itemY);
            else if (flaw === 'smell') drawChemicalSmell(userChoices.product, itemX, itemY);
            else if (flaw === 'fuzzies') drawFuzzies(userChoices.product, itemX, itemY);
            
            if (count === 1) {
                const btnRevise = { id: 'revise', text: 'Request another revision (+2 Weeks)', x: canvas.width/2 - 300, y: 550, w: 600, h: 80};
                const btnBui = { id: 'bui', text: 'There must be a better way...', x: canvas.width/2 - 300, y: 650, w: 600, h: 80};
                drawButton(btnRevise.text, btnRevise.x, btnRevise.y, btnRevise.w, btnRevise.h, hoverTarget === btnRevise.id, false, btnRevise.id);
                drawButton(btnBui.text, btnBui.x, btnBui.y, btnBui.w, btnBui.h, hoverTarget === btnBui.id, false, btnBui.id);
                setRegions([btnRevise, btnBui]);
            } else {
                const btnBui = { id: 'bui', text: 'There must be a better way...', x: canvas.width/2 - 300, y: 650, w: 600, h: 80};
                drawButton(btnBui.text, btnBui.x, btnBui.y, btnBui.w, btnBui.h, hoverTarget === btnBui.id, false, btnBui.id);
                setRegions([btnBui]);
            }
        }
    }
    
    function drawShowEmailTextScreen() {
        const textX = 150;
        const textY = 100;
        const textW = canvas.width - 300;
        const textH = canvas.height - 200;
        const lineHeight = 25;

        // Draw background
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.fillRect(textX - 20, textY - 20, textW + 40, textH + 40);
        ctx.strokeStyle = '#ffff00';
        ctx.strokeRect(textX - 20, textY - 20, textW + 40, textH + 40);

        ctx.save();
        ctx.rect(textX, textY, textW, textH);
        ctx.clip();

        // Draw text
        ctx.font = `14px "Press Start 2P"`;
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'left';
        for(let i=0; i < emailTextLines.length; i++) {
            const lineY = textY + (i * lineHeight) - animationState.textScrollY;
            if(lineY > textY - lineHeight && lineY < textY + textH + lineHeight) {
                ctx.fillText(emailTextLines[i], textX + 10, lineY);
            }
        }
        ctx.restore();
        
        // Scroll prompt
        drawText("Use Mouse Wheel to Scroll", canvas.width / 2, textY + textH + 50, 16, '#888');

        // Check if scrolled to bottom
        if (animationState.textScrollY >= animationState.maxScrollY - 5) { // -5 for buffer
            const btnPoint = { id: 'point', text: 'You have a point...', x: canvas.width/2 - 250, y: 720, w: 500, h: 60};
            drawButton(btnPoint.text, btnPoint.x, btnPoint.y, btnPoint.w, btnPoint.h, hoverTarget === btnPoint.id, false, btnPoint.id);
            setRegions([btnPoint]);
        } else {
            setRegions([]); // No buttons if not at the bottom
        }
    }

    function drawRevealPerfectScreen() {
        drawText("The perfect item has arrived!", canvas.width / 2, 200, 30, '#00ff00');
        idealProducts[userChoices.product].draw(canvas.width / 2 - 100, 300, 1.5);
    }

    // --- Core Logic ---
    function determineFlaw() {
        if (userChoices.missedStitching) return 'stitching';
        if (userChoices.choseBudgetFabric) return 'color';
        if (userChoices.factoryMismatch) return 'size'; // Changed from 'fit' to 'size'
        const randomFlaws = ['stitching', 'color', 'size', 'smell', 'fuzzies'];
        return randomFlaws[Math.floor(Math.random() * randomFlaws.length)];
    }

    // Text wrapping utility
    function wrapText(text, maxWidth) {
        const paragraphs = text.split('\n');
        const lines = [];
        ctx.font = `14px "Press Start 2P"`;

        paragraphs.forEach(p => {
            if (p === '') {
                lines.push('');
                return;
            }
            const words = p.split(' ');
            let currentLine = words[0];
            for (let i = 1; i < words.length; i++) {
                const word = words[i];
                const width = ctx.measureText(currentLine + " " + word).width;
                if (width < maxWidth) {
                    currentLine += " " + word;
                } else {
                    lines.push(currentLine);
                    currentLine = word;
                }
            }
            lines.push(currentLine);
        });
        return lines;
    }

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        animationState.frame++;
        
        switch (gameState) {
            case GAME_STATES.CHOOSE_PRODUCT: drawChooseProductScreen(); break;
            case GAME_STATES.CREATE_TECH_PACK: drawCreateTechPackScreen(); break;
            case GAME_STATES.CHOOSE_FABRIC: drawChooseFabricScreen(); break;
            case GAME_STATES.CHOOSE_MANUFACTURER: drawManufacturerScreen(); break;
            case GAME_STATES.SAMPLING_LOOP: drawSamplingLoopScreen(); break;
            case GAME_STATES.SHOW_EMAIL_TEXT: drawShowEmailTextScreen(); break;
            case GAME_STATES.REVEAL_PERFECT: drawRevealPerfectScreen(); break;
        }
        requestAnimationFrame(gameLoop);
    }
    
    // --- Event Handlers ---
    function handleClick(event) {
        const rect = canvas.getBoundingClientRect();
        const mouseX = event.clientX - rect.left;
        const mouseY = event.clientY - rect.top;

        const regions = clickRegions[gameState] || [];
        for (const region of regions) {
            if (mouseX >= region.x && mouseX <= region.x + region.w &&
                mouseY >= region.y && mouseY <= region.y + region.h) {
                switch(gameState) {
                    case GAME_STATES.CHOOSE_PRODUCT:
                        userChoices.product = region.id;
                        gameState = GAME_STATES.CREATE_TECH_PACK;
                        break;
                    case GAME_STATES.CREATE_TECH_PACK:
                        if (region.id === 'send') {
                             if (!userChoices.techPack.stitching) userChoices.missedStitching = true;
                             gameState = GAME_STATES.CHOOSE_FABRIC;
                        } else {
                            userChoices.techPack[region.id] = true;
                        }
                        break;
                    case GAME_STATES.CHOOSE_FABRIC:
                        userChoices.fabricChoice = region.id;
                        if(region.id === 'budget') userChoices.choseBudgetFabric = true;
                        gameState = GAME_STATES.CHOOSE_MANUFACTURER;
                        break;
                    case GAME_STATES.CHOOSE_MANUFACTURER:
                        userChoices.manufacturer = region.id;
                        if (userChoices.product === 'top' && region.id !== 'portugal') userChoices.factoryMismatch = true;
                        if (userChoices.product === 'hat' && region.id === 'germany') userChoices.factoryMismatch = true;
                        if (userChoices.product === 'pants' && region.id === 'portugal') userChoices.factoryMismatch = true;
                        
                        userChoices.sampling.flaw = determineFlaw();
                        animationState.subState = 0; // Start shipping animation
                        animationState.x = -200;
                        gameState = GAME_STATES.SAMPLING_LOOP;
                        break;
                    case GAME_STATES.SAMPLING_LOOP:
                         if(region.id === 'revise') {
                             userChoices.sampling.count++;
                             userChoices.sampling.time += 2;
                             userChoices.sampling.flaw = determineFlaw();
                             animationState.subState = 0; // Back to shipping
                             animationState.x = -200;
                         } else if (region.id === 'bui') {
                             gameState = GAME_STATES.SHOW_EMAIL_TEXT;
                             animationState.textScrollY = 0;
                             // Pre-calculate wrapped text and max scroll
                             emailTextLines = wrapText(emailText, canvas.width - 320);
                             const totalTextHeight = emailTextLines.length * 25; // 25 is line height
                             const visibleHeight = canvas.height - 200;
                             animationState.maxScrollY = Math.max(0, totalTextHeight - visibleHeight);
                         }
                         break;
                    case GAME_STATES.SHOW_EMAIL_TEXT:
                        if (region.id === 'point') {
                             gameState = GAME_STATES.REVEAL_PERFECT;
                             setTimeout(() => {
                                 messageOverlay.style.display = 'flex';
                                 messageText.innerHTML = `The perfect item has arrived.
                                 <div class="cta-container">
                                    <a href="https://buiproject.notion.site/projects-by-bui" target="_blank" class="cta-button">Want to see more?</a>
                                    <a href="https://www.notion.so/buiproject/BUI-Production-Q-A-Guiding-the-Conversation-280972fdd7d78051a4fec8a689404dc5?source=copy_link" target="_blank" class="cta-button">Want to know more (professionally)?</a>
                                    <a href="https://calendar.app.google/ViFSYWDaHVhr78wg6" target="_blank" class="cta-button">Want to know more (personally)?</a>
                                 </div>`;
                             }, 2000);
                        }
                        break;
                }
                return;
            }
        }
    }
    
    function handleWheel(event) {
        if(gameState === GAME_STATES.SHOW_EMAIL_TEXT) {
            event.preventDefault();
            animationState.textScrollY += event.deltaY * 0.5;
            // Clamp scroll
            if(animationState.textScrollY < 0) animationState.textScrollY = 0;
            if(animationState.textScrollY > animationState.maxScrollY) animationState.textScrollY = animationState.maxScrollY;
        }
    }
    
    function drawButton(text, x, y, w, h, isHovered, isDone, id = null) {
        ctx.strokeStyle = '#fff';
        if(isDone) ctx.fillStyle = '#00ff00';
        else ctx.fillStyle = isHovered ? '#ffff00' : '#555';
        ctx.fillRect(x,y,w,h);
        ctx.strokeRect(x,y,w,h);
        drawText(text, x + w/2, y + h/2 + 4, id === 'stitching' ? 12 : 16, isHovered || isDone ? '#000' : '#fff');
    }
    
    function drawText(text, x, y, size = 32, color = '#fff') {
            ctx.font = `${size}px "Press Start 2P"`;
            ctx.fillStyle = color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x, y);
    }
    
    function handleMouseMove(event) {
        const rect = canvas.getBoundingClientRect();
        const mouseX = event.clientX - rect.left;
        const mouseY = event.clientY - rect.top;
        const regions = clickRegions[gameState] || [];
        hoverTarget = null;
        canvas.style.cursor = 'default';
        for (const region of regions) {
             if (mouseX >= region.x && mouseX <= region.x + region.w &&
                 mouseY >= region.y && mouseY <= region.y + region.h) {
                 hoverTarget = region.id;
                 canvas.style.cursor = 'pointer';
                 break;
             }
        }
    }
    canvas.addEventListener('click', handleClick);
    canvas.addEventListener('mousemove', handleMouseMove);
    canvas.addEventListener('wheel', handleWheel);

    initializeGame();
    gameLoop();

</script>

</body>
</html>


